<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>main</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>

<style>

</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
<body>
<div th:fragment="header">
    <div class="row">
        <div class="col-8">
            <div class="row">
                <div class="col-3">
                    <a href="/">
                        <img src="/img/logo.png" class="mt-2 ms-2" style="cursor: pointer; height: 46px;">
                    </a>
                </div>
                <div class="col mt-1">
                    <div class="row mt-3 fw-semibold">
                        <div class="col">
                            <a href="/qna" id="qnaLink" class="text-secondary">개발자 Q&A</a>
                            <a href="/project" class="ms-4 text-secondary" id="projectLink">프로젝트 / 스터디 찾기</a>
                            <a class="ms-4 text-secondary" id="noticeLink"> 공지사항</a>
                        </div>

                    </div>
                </div>
            </div>

        </div>
        <div class="col">

            <div class="row mt-3 me-2">
                <div class="col-7 text-end" th:if="${session.userDTO == null}"></div>
                <div class="col-5 text-end" th:if="${session.userDTO != null}"></div>
                <div class="col text-start" th:if="${session.userDTO != null}">
                    <div class="row">
                        <div class="col ms-5">
                            <i class="bi bi-bookmark fs-4 ms-5 text-secondary"></i>
                        </div>
                        <div class="col">
                            <a href="/user/message">
                                <i class="bi bi-envelope alarmBell fs-4 ms-2 text-secondary"
                                style="cursor: pointer;"></i>
                            </a>

                        </div>
                        <div class="col">
                            <i class="bi bi-bell alarmBell fs-4 ms-1 text-secondary" style="cursor:pointer;"
                            id="dropAlarmButton" data-bs-toggle="dropdown" aria-expanded="false"></i>
                            <div class="dropdown-menu row bg-light Small shadow" aria-labelledby="dropAlarmButton" style="width: 480px">
                                <div class="col">

                                    <div class="row">
                                        <div class="col p-1 fw-semibold border-bottom border-1">
                                            <span class="ms-3" style="position: relative; bottom: 3px;"> 알림 </span>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col bg-white">

                                          <div class="row mt-2 mb-2"></div>

                                            <!---->
                                            <div id="notification-list"></div>


                                        </div>
                                    </div>
                                </div>
                            </div>
                         </div>
                        <div class="col me-3">
                            <img class="rounded-circle" style="width: 35px; height: 35px; cursor: pointer;"
                                 src="/img/user.jpg" th:if="${session.userDTO.fileAttached == 0}"
                            id="dropButton" data-bs-toggle="dropdown" aria-expanded="false">
                            <img class="rounded-circle" style="width: 35px; height: 35px; cursor: pointer;"
                                 th:src="@{|/upload/${session.userDTO.storedFileName}|}"
                                 th:if="${session.userDTO.fileAttached == 1}"
                                 id="dropButton1" data-bs-toggle="dropdown" aria-expanded="false">
                            <ul class="dropdown-menu Small shadow" aria-labelledby="dropButton" style="width: 200px">
                                <li class="mb-2 mt-1">
                                    <span class="fw-semibold ms-3">내 계정</span>
                                </li>
                                <li class="mb-1">
                                    <a class="dropdown-item" href="/user/myPage">
                                        <i class="bi bi-person-circle"></i>
                                        <span class="ms-2">프로필</span>
                                    </a>
                                </li>
                                <li class="mb-1">
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-bookmark"></i>
                                        <span class="ms-2"> 스크랩 </span>
                                    </a>
                                </li>
                                <li class="mb-1">
                                    <a class="dropdown-item" href="/user/message">
                                        <i class="bi bi-envelope"></i>
                                        <span class="ms-2"> 메시지 </span>
                                    </a>
                                </li>
                                <div class="border-bottom mt-2 mb-2"></div>
                                <li>
                                    <a class="dropdown-item" href="/user/logout">
                                        <i class="bi bi-box-arrow-right"></i>
                                        <span class="ms-2"> 로그아웃 </span>
                                    </a>
                                </li>


                            </ul>
                            <ul class="dropdown-menu Small shadow" aria-labelledby="dropButton1" style="width: 200px">
                                <li class="mb-2 mt-1">
                                    <span class="fw-semibold ms-3">내 계정</span>
                                </li>
                                <li class="mb-1">
                                    <a class="dropdown-item" href="/user/myPage">
                                        <i class="bi bi-person-circle"></i>
                                        <span class="ms-2">프로필</span>
                                    </a>
                                </li>
                                <li class="mb-1">
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-bookmark"></i>
                                        <span class="ms-2"> 스크랩 </span>
                                    </a>
                                </li>
                                <li class="mb-1">
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-envelope"></i>
                                        <span class="ms-2"> 쪽지함 </span>
                                    </a>
                                </li>
                                <div class="border-bottom mt-2 mb-2"></div>
                                <li class="mb-1">
                                    <a class="dropdown-item" href="/user/logout">
                                        <i class="bi bi-box-arrow-right"></i>
                                        <span class="ms-1"> 로그아웃 </span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

<!--                    <span class="fw-bold" th:text="${session.userDTO.nickname}"></span>-->
<!--                    <span class="me-1">님</span>-->
<!--                    <span class="me-1" onclick="logout()" style="cursor: pointer;">로그아웃</span>-->
                </div>
                <div class="col text-start" th:if="${session.userDTO == null}">
                    <button class="btn btn-outline-dark fw-semibold" onclick="loginPage()">로그인</button>
                    <button class="btn mainButton" onclick="joinPage()">회원가입</button>
                </div>
            </div>

        </div>
    </div>

    <div class="border-bottom mt-2"></div>

</div>
<script th:inline="javascript">

    /*<![CDATA[*/
     let sessionId = [[${session.userDTO != null ? session.userDTO.id : 0}]];
 /*]]>*/



  const getNotificationList = () => {
        $.ajax({
         type: "get",
         url: "/notification/findAll/" + sessionId,
         success: function(res) {
            let output = "";
             if (res == null) {
                output += '<div class="text-center mt-3">알림이 존재하지 않습니다.</div>';
            } else {
              for (let i in res) {
                output += '<a href="' + res[i].notUrl + '">';
                output += '<div class="row mt-2">';
                output += '<div class="col ms-3">';

                output += '<div class="row">';
                output += '<div class="col-1">';
                if (res[i].fileAttached == 0) {
                    output += '<img src="/img/user.jpg" class="rounded-circle" style="width: 28px; height: 28px; position: relative; bottom: 1px">';
                } else if (res[i].fileAttached == 1) {
                    output += '<img class="rounded-circle" src="/upload/' + res[i].storedFileName + '" style="width: 28px; height: 28px; position: relative; bottom: 1px">';
                }
                output += '</div>';
                output += '<div class="col ms-2 fw-semibold">' + res[i].sender + '</div>';
                output += '<div class="col text-end text-secondary me-1">' + formatDateTime(res[i].occurDate) + '</div>';
                output += '</div>';

                output += '<div class="row">';
                output += '<div class="col-1">';
                output += '</div>';
                output += '<div class="col ms-2">' + res[i].sentence + '</div>';
                output += '</div>';

                output += '<div class="border-bottom mt-2">' + '</div>';

                output += '</div>';
                output += '</div>';
                output += '</a>';
                }
            }
            document.getElementById('notification-list').innerHTML = output;
         },
         error: function(err) {
             return;
         }
     });

  }


    const formatDateTime = (dateString) => {

     const date = new Date(dateString);
     const now = new Date();

     const timeDiff = now.getTime() - date.getTime(); // 현재 시간과 작성일과의 차이 (밀리초 단위)
     const minutesDiff = Math.floor(timeDiff / (1000 * 60)); // 분 단위로 변환

     // 1시간 이내일 경우
     if (minutesDiff < 60) {
        // 1분 미만일 경우
         if (minutesDiff < 1) {
           return '방금 전';
         }
         // 1분 이상일 경우
         else {
           return minutesDiff + '분 전';
         }
     }
    // 24시간 이내일 경우
    else if (minutesDiff < 1440) {

         const hoursDiff = Math.floor(minutesDiff / 60);
         return hoursDiff + '시간 전';
    }
 // 30일 이내일 경우
 else if (minutesDiff < 30 * 24 * 60) {
     const daysDiff = Math.floor(minutesDiff / (24 * 60));
     return daysDiff + '일 전';
 }
 // 12개월 이내일 경우
 else if (minutesDiff < 12 * 30 * 24 * 60) {
     const monthsDiff = Math.floor(minutesDiff / (30 * 24 * 60));
     return monthsDiff + '달 전';
 }
   const year = date.getFullYear();
   const month = date.getMonth() + 1;
   const day = date.getDate();
   let hours = date.getHours();
   const minutes = date.getMinutes();
   let period = '오전';

   if (hours >= 12) {
     period = '오후';
     if (hours > 12) {
       hours -= 12;
     }
   } else if (hours === 0) {
     hours = 12;
   }

   const formattedDateTime = year + '-' + ('0' + month).slice(-2) + '-' + ('0' + day).slice(-2) + ' ' + period + ' ' + ('0' + hours).slice(-2) + ':' + ('0' + minutes).slice(-2);
   return formattedDateTime;
 }


window.addEventListener("DOMContentLoaded", function(){
    if (sessionId != 0) {
        getNotificationList();
    }
 });
});

</script>
</body>
</html>